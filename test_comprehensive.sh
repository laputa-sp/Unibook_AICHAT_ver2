#!/bin/bash

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ì¢…í•© í…ŒìŠ¤íŠ¸: FTS5 í•œêµ­ì–´, ìºì‹±, Qdrant, ì¶œì²˜
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

API_URL="http://localhost:8080"
TEST_ISBN="9791234567890"
USER_ID="test_user_comprehensive"
SESSION_ID="session_$(date +%s)"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“š ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ISBN: $TEST_ISBN"
echo "Session: $SESSION_ID"
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Test 1: FTS5 í•œêµ­ì–´ ì™€ì¼ë“œì¹´ë“œ ê²€ìƒ‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 1: FTS5 í•œêµ­ì–´ ì™€ì¼ë“œì¹´ë“œ ê²€ìƒ‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ì§ˆë¬¸: ë‚´í–¥í˜•ê³¼ ì™¸í–¥í˜•ì˜ ì°¨ì´ëŠ”?"
echo ""

START_TIME=$(date +%s%N)
curl -s -X POST "$API_URL/api/chat/v1/response/stream" \
  -H "Content-Type: application/json" \
  -d '{
    "userid": "'$USER_ID'",
    "sessionid": "'$SESSION_ID'",
    "isbn": "'$TEST_ISBN'",
    "query": "ë‚´í–¥í˜•ê³¼ ì™¸í–¥í˜•ì˜ ì°¨ì´ëŠ”?"
  }' > /tmp/test1_korean_search.txt

END_TIME=$(date +%s%N)
ELAPSED_MS=$(( (END_TIME - START_TIME) / 1000000 ))

echo "â±ï¸  ì‘ë‹µ ì‹œê°„: ${ELAPSED_MS}ms"
echo ""
echo "ğŸ“„ ì‘ë‹µ ë‚´ìš© (ì²˜ìŒ 500ì):"
head -c 500 /tmp/test1_korean_search.txt
echo ""
echo ""
echo "ğŸ” ì¶œì²˜ í™•ì¸:"
if grep -q "ì¶œì²˜" /tmp/test1_korean_search.txt; then
    grep "ì¶œì²˜" /tmp/test1_korean_search.txt | head -5
    echo "âœ… ì¶œì²˜ í¬í•¨ë¨"
else
    echo "âŒ ì¶œì²˜ ì—†ìŒ!"
fi
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Test 2: ìºì‹± ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (3íšŒ ë°˜ë³µ)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 2: ìºì‹± ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (MBTIê°€ ë­ì•¼? x3)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

CACHE_SESSION="cache_test_$(date +%s)"

for i in 1 2 3; do
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”„ ìš”ì²­ #$i: MBTIê°€ ë­ì•¼?"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    START_TIME=$(date +%s%N)
    curl -s -X POST "$API_URL/api/chat/v1/response/stream" \
      -H "Content-Type: application/json" \
      -d '{
        "userid": "'$USER_ID'",
        "sessionid": "'$CACHE_SESSION'",
        "isbn": "'$TEST_ISBN'",
        "query": "MBTIê°€ ë­ì•¼?"
      }' > /tmp/cache_test_${i}.txt

    END_TIME=$(date +%s%N)
    ELAPSED_MS=$(( (END_TIME - START_TIME) / 1000000 ))

    echo "â±ï¸  ì‘ë‹µ ì‹œê°„: ${ELAPSED_MS}ms"

    # ìºì‹œ íˆíŠ¸ í™•ì¸
    echo "ğŸ” ìºì‹œ ë¡œê·¸ í™•ì¸:"
    tail -20 logs/server.log | grep -E "(CACHE HIT|STREAM CACHE|Cached streaming)" | tail -3
    echo ""

    sleep 1
done

# ìºì‹œ í†µê³„
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š ìºì‹œ í†µê³„"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
curl -s "$API_URL/api/chat/cache/stats" | python3 -m json.tool
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Test 3: Qdrant ì‹œë§¨í‹± ê²€ìƒ‰ (ì˜ë¯¸ ê¸°ë°˜)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 3: Qdrant ì‹œë§¨í‹± ê²€ìƒ‰ í…ŒìŠ¤íŠ¸"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ì§ˆë¬¸: ìì‹ ê°ì´ ë†’ì€ ì‚¬ëŒì˜ íŠ¹ì§•ì€?"
echo ""

QDRANT_SESSION="qdrant_test_$(date +%s)"

START_TIME=$(date +%s%N)
curl -s -X POST "$API_URL/api/chat/v1/response/stream" \
  -H "Content-Type: application/json" \
  -d '{
    "userid": "'$USER_ID'",
    "sessionid": "'$QDRANT_SESSION'",
    "isbn": "'$TEST_ISBN'",
    "query": "ìì‹ ê°ì´ ë†’ì€ ì‚¬ëŒì˜ íŠ¹ì§•ì€?"
  }' > /tmp/test3_semantic.txt

END_TIME=$(date +%s%N)
ELAPSED_MS=$(( (END_TIME - START_TIME) / 1000000 ))

echo "â±ï¸  ì‘ë‹µ ì‹œê°„: ${ELAPSED_MS}ms"
echo ""
echo "ğŸ“„ ì‘ë‹µ ë‚´ìš© (ì²˜ìŒ 500ì):"
head -c 500 /tmp/test3_semantic.txt
echo ""
echo ""
echo "ğŸ” ê²€ìƒ‰ íƒ€ì… í™•ì¸ (ë¡œê·¸):"
tail -30 logs/server.log | grep -E "(searchType|Semantic search|Qdrant)" | tail -5
echo ""

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ìµœì¢… ìš”ì•½
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ì¢…í•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ ê²°ê³¼ íŒŒì¼:"
echo "   - /tmp/test1_korean_search.txt"
echo "   - /tmp/cache_test_1.txt"
echo "   - /tmp/cache_test_2.txt"
echo "   - /tmp/cache_test_3.txt"
echo "   - /tmp/test3_semantic.txt"
echo ""
echo "ğŸ“‹ ê²€ì¦ í•­ëª©:"
echo "   1. FTS5 í•œêµ­ì–´ ì™€ì¼ë“œì¹´ë“œ ê²€ìƒ‰: $(grep -q "ë‚´í–¥" /tmp/test1_korean_search.txt && echo 'âœ… ì‘ë™' || echo 'âŒ ì‹¤íŒ¨')"
echo "   2. ì¶œì²˜ í‘œì‹œ: $(grep -q "ì¶œì²˜" /tmp/test1_korean_search.txt && echo 'âœ… í¬í•¨' || echo 'âŒ ì—†ìŒ')"
echo "   3. ìºì‹± (2íšŒì°¨): $(test $(stat -c%s /tmp/cache_test_2.txt) -gt 100 && echo 'âœ… ì‘ë™' || echo 'âŒ ì‹¤íŒ¨')"
echo ""
